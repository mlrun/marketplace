
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>MLflow tracker demo</title>
<!-- Loaded before other Sphinx assets -->
<link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../../../_static/togglebutton.css" rel="stylesheet" type="text/css">
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script src="../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<script data-url_root="./" id="documentation_options" src="../../../_static/documentation_options.js"></script>
<script src="../../../_static/jquery.js"></script>
<script src="../../../_static/underscore.js"></script>
<script src="../../../_static/doctools.js"></script>
<script>let toggleHintShow = 'Click to show';</script>
<script>let toggleHintHide = 'Click to hide';</script>
<script>let toggleOpenOnPrint = 'true';</script>
<script src="../../../_static/togglebutton.js"></script>
<script src="../../../_static/scripts/sphinx-book-theme.js"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
<link href="genindex.html" rel="index" title="Index">
<link href="search.html" rel="search" title="Search">
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint single-page" id="site-navigation">
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
</div>
<div class="header-article__right">
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<div class="menu-dropdown menu-dropdown-repository-buttons">
<button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
<i class="fab fa-github"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/mlrun/marketplace" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
<span class="headerbtn__text-container">repository</span>
</a>
</li>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/mlrun/marketplace/issues/new?title=Issue%20on%20page%20%2Fmlflow_utils_example.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
<span class="headerbtn__icon-container">
<i class="fas fa-lightbulb"></i>
</span>
<span class="headerbtn__text-container">open issue</span>
</a>
</li>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/mlrun/marketplace/edit/master/docs/mlflow_utils_example.ipynb" title="Edit this page">
<span class="headerbtn__icon-container">
<i class="fas fa-pencil-alt"></i>
</span>
<span class="headerbtn__text-container">suggest edit</span>
</a>
</li>
</ul>
</div>
</div>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../src/mlflow_utils.ipynb" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.ipynb</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#mlrun-installation-and-configuration">
   MLRun installation and configuration
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#create-a-feature-set-and-ingest-data">
   Create a feature set and ingest data
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#create-a-data-processing-function">
   Create a data processing function
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#create-an-mlflow-xgboost-function">
   Create an MLflow Xgboost function
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#log-the-data-from-mlflow-in-mlrun">
   Log the data from MLflow in MLRun
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#change-the-mlrun-configuration-to-use-the-tracker">
     Change the MLRun configuration to use the tracker
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#create-the-mlrun-function">
     Create the mlrun function
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#run-the-function">
     Run the function
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#examine-the-results">
     Examine the results
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#you-can-also-examine-the-results-using-the-ui">
     You can also examine the results using the UI
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#use-the-function-for-model-serving">
   Use the function for model serving
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#create-the-server-and-serving-function">
     Create the server and serving function
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#test-the-model">
     Test the model
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>MLflow tracker demo</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#mlrun-installation-and-configuration">
   MLRun installation and configuration
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#create-a-feature-set-and-ingest-data">
   Create a feature set and ingest data
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#create-a-data-processing-function">
   Create a data processing function
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#create-an-mlflow-xgboost-function">
   Create an MLflow Xgboost function
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#log-the-data-from-mlflow-in-mlrun">
   Log the data from MLflow in MLRun
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#change-the-mlrun-configuration-to-use-the-tracker">
     Change the MLRun configuration to use the tracker
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#create-the-mlrun-function">
     Create the mlrun function
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#run-the-function">
     Run the function
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#examine-the-results">
     Examine the results
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#you-can-also-examine-the-results-using-the-ui">
     You can also examine the results using the UI
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#use-the-function-for-model-serving">
   Use the function for model serving
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#create-the-server-and-serving-function">
     Create the server and serving function
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#test-the-model">
     Test the model
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<section id="mlflow-tracker-demo">
<h1>MLflow tracker demo<a class="headerlink" href="#mlflow-tracker-demo" title="Permalink to this headline">#</a></h1>
<p>This demo demonstrates how to seamlessly integrate and transfer logs from MLflow to MLRun, 
creating a unified and powerful platform for your machine learning experiments.</p>
<p>You can combine MLflow and MLRun for a comprehensive solution for managing, tracking, and deploying machine learning models.</p>
<p>This notebook guides you through the process of:</p>
<ol class="arabic simple">
<li><p>Setting up the integration between MLflow and MLRun.</p></li>
<li><p>Extracting data, metrics, and artifacts from MLflow experiments.</p></li>
<li><p>Creating MLRun artifacts and projects to organize and manage the transferred data.</p></li>
<li><p>Leveraging MLRun’s capabilities for model deployment and data processing.</p></li>
</ol>
<p>By the end of this demo, you will have a understanding of how to establish a smooth flow of data between MLflow and MLRun.</p>
<section id="mlrun-installation-and-configuration">
<h2>MLRun installation and configuration<a class="headerlink" href="#mlrun-installation-and-configuration" title="Permalink to this headline">#</a></h2>
<p>Before running this notebook make sure the mlrun package is installed (pip install mlrun) and that you have configured the access to MLRun service.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install MLRun and scikit-learn if not already installed. Run this only once. Restart the notebook after the install!</span>
<span class="c1"># %pip install mlrun scikit-learn~=1.3.0</span>
</pre></div>
</div>
</div>
</div>
<p>Then you can import the necessary packages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mlrun</span>
<span class="kn">from</span> <span class="nn">mlrun.datastore.targets</span> <span class="kn">import</span> <span class="n">ParquetTarget</span>
<span class="kn">import</span> <span class="nn">mlrun.feature_store</span> <span class="k">as</span> <span class="nn">fstore</span>
</pre></div>
</div>
</div>
</div>
<p>Create a project for this demo:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a project for this demo:</span>
<span class="n">project</span> <span class="o">=</span> <span class="n">mlrun</span><span class="o">.</span><span class="n">get_or_create_project</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"mlflow-tracking-example"</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s2">"./"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&gt; 2024-03-27 15:34:40,940 [info] Project loaded successfully: {'project_name': 'mlflow-tracking-example-guy'}
</pre></div>
</div>
</div>
</div>
<p>Set all the necessary environment variables for the Databricks cluster:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DATABRICKS_HOST</span><span class="o">=</span><span class="s2">"add your host"</span>
<span class="n">DATABRICKS_TOKEN</span><span class="o">=</span><span class="s2">"add your token"</span>
<span class="n">DATABRICKS_CLUSTER_ID</span><span class="o">=</span><span class="s2">"add your cluster id"</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"DATABRICKS_HOST"</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATABRICKS_HOST</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"DATABRICKS_TOKEN"</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATABRICKS_TOKEN</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the Databricks environment variables</span>
<span class="n">job_env</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"DATABRICKS_HOST"</span><span class="p">:</span> <span class="n">DATABRICKS_HOST</span><span class="p">,</span>
    <span class="s2">"DATABRICKS_CLUSTER_ID"</span><span class="p">:</span> <span class="n">DATABRICKS_CLUSTER_ID</span>
<span class="p">}</span>
<span class="n">secrets</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"DATABRICKS_TOKEN"</span><span class="p">:</span> <span class="n">DATABRICKS_TOKEN</span><span class="p">}</span>

<span class="c1"># Set the secrets in the project</span>
<span class="n">project</span><span class="o">.</span><span class="n">set_secrets</span><span class="p">(</span><span class="n">secrets</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-feature-set-and-ingest-data">
<h2>Create a feature set and ingest data<a class="headerlink" href="#create-a-feature-set-and-ingest-data" title="Permalink to this headline">#</a></h2>
<p>This is a short example of how to create a feature set about music preferences.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create df</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">,</span> <span class="s2">"age"</span><span class="p">,</span> <span class="s2">"gender"</span><span class="p">,</span> <span class="s2">"favorite_music_type"</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"Alice"</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"Bob"</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Rock"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"Charlie"</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">"David"</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Classical"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">"Eva"</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">"Frank"</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Rock"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s2">"Grace"</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">"Henry"</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Classical"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s2">"Ivy"</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">"Jack"</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Classical"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s2">"Karen"</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s2">"Liam"</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="s2">"Mia"</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Rock"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="s2">"Nora"</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Rock"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s2">"Oliver"</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s2">"Ben"</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="s2">"Alicia"</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="s2">"Bobby"</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Rock"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="s2">"Charlien"</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">"Davide"</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Classical"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="s2">"Evans"</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="s2">"Franklin"</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Rock"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="s2">"Grace"</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s2">"Henrik"</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Classical"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="s2">"eevee"</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="s2">"Jack"</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Classical"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="s2">"Karen"</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="s2">"Lian"</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">29</span><span class="p">,</span> <span class="s2">"kia"</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Rock"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s2">"Novak"</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Rock"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="s2">"Olivia"</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s2">"Benjamin"</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"Pop"</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Transfer the data to DataBricks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Where to save the data in DataBricks</span>
<span class="n">target_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"dbfs:///demos/mlrun_databricks_demo/music.parquet"</span>
<span class="n">output_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"dbfs:///demos/mlrun_databricks_demo/music_output_new.parquet"</span>

<span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">ParquetTarget</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">target_path</span><span class="p">)]</span>

<span class="c1"># Create a feature set and ingest the data</span>
<span class="n">fset</span> <span class="o">=</span> <span class="n">fstore</span><span class="o">.</span><span class="n">FeatureSet</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"music_fset"</span><span class="p">,</span> <span class="n">entities</span><span class="o">=</span><span class="p">[</span><span class="n">fstore</span><span class="o">.</span><span class="n">Entity</span><span class="p">(</span><span class="s2">"name"</span><span class="p">)])</span>
<span class="n">fstore</span><span class="o">.</span><span class="n">ingest</span><span class="p">(</span><span class="n">fset</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Get the target path and check it</span>
<span class="n">dbfs_data_path</span> <span class="o">=</span> <span class="n">fset</span><span class="o">.</span><span class="n">get_target_path</span><span class="p">()</span>
<span class="n">dbfs_data_path</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>'dbfs:///demos/mlrun_databricks_demo/1711553684480_33/music.parquet'
</pre></div>
</div>
</div>
</div>
<p>We can look and see how how our data is logged in the DataBricks cluster:
(only top 20 rows)</p>
<p><img alt="image.png" src="attachment:f7ad0425-26fe-482c-b97c-c9493b05fbf2.png"/></p>
</section>
<section id="create-a-data-processing-function">
<h2>Create a data processing function<a class="headerlink" href="#create-a-data-processing-function" title="Permalink to this headline">#</a></h2>
<p>The following code demonstrates how to create a simple data processing function using MLRun.
The function will process the data and show some statistics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> process_data.py


<span class="c1">#  Here is an example of Spark processing.</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">avg</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">fsspec</span>

<span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">"MusicDemo"</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
    <span class="n">spark_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">spark_df</span> <span class="o">=</span> <span class="n">spark_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">)</span>
    
    <span class="n">music_stats</span> <span class="o">=</span> <span class="n">spark_df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">"favorite_music_type"</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">avg</span><span class="p">(</span><span class="s2">"age"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"avg_age"</span><span class="p">),</span>
        <span class="nb">min</span><span class="p">(</span><span class="s2">"age"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"min_age"</span><span class="p">),</span>
        <span class="nb">max</span><span class="p">(</span><span class="s2">"age"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"max_age"</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">music_stats</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">pandas_df</span> <span class="o">=</span> <span class="n">spark_df</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
    <span class="n">pandas_df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">data_output_path</span><span class="p">)</span>
    <span class="c1"># spark_df.write.mode("overwrite").parquet(data_output_path)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">"music_data"</span><span class="p">:</span> <span class="n">data_output_path</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">process_data_function</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">set_function</span><span class="p">(</span>
    <span class="n">func</span><span class="o">=</span><span class="s2">"./zeev-demos/mlflow-databricks/process_data.py"</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"process-data"</span><span class="p">,</span>
    <span class="n">kind</span><span class="o">=</span><span class="s2">"databricks"</span><span class="p">,</span>
    <span class="n">image</span><span class="o">=</span><span class="s2">"mlrun/mlrun"</span><span class="p">,</span>
<span class="p">)</span>
                                
</pre></div>
</div>
</div>
</div>
<p>Set all parameters necessary for the function and run it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">job_env</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">process_data_function</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"task_parameters"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"timeout_minutes"</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
    <span class="s2">"data_path"</span><span class="p">:</span> <span class="n">dbfs_data_path</span><span class="p">,</span>
    <span class="s2">"data_output_path"</span><span class="p">:</span> <span class="n">output_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"dbfs://"</span><span class="p">,</span> <span class="s2">"/dbfs"</span><span class="p">),</span>
<span class="p">}</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">process_data_function</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">handler</span><span class="o">=</span><span class="s2">"process_data"</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&gt; 2024-03-27 15:34:45,422 [info] Storing function: {'name': 'process-data-process-data', 'uid': 'a9c770f8377046bda3061e61a5c015c2', 'db': 'http://mlrun-api:8080'}
&gt; 2024-03-27 15:34:45,675 [info] Job is running in the background, pod: process-data-process-data-89bhh
&gt; 2024-03-27 15:34:49,272 [info] Running with an existing cluster: {'cluster_id': '0327-134616-43m7kfxk'}
&gt; 2024-03-27 15:34:49,492 [info] Starting to poll: 493449112310004
&gt; 2024-03-27 15:34:49,539 [info] Workflow intermediate status: mlrun_task__15_34_48_703046: RunLifeCycleState.PENDING
&gt; 2024-03-27 15:34:50,947 [info] Workflow intermediate status: mlrun_task__15_34_48_703046: RunLifeCycleState.PENDING
&gt; 2024-03-27 15:34:53,063 [info] Workflow intermediate status: mlrun_task__15_34_48_703046: RunLifeCycleState.RUNNING
&gt; 2024-03-27 15:34:56,737 [info] Workflow intermediate status: mlrun_task__15_34_48_703046: RunLifeCycleState.RUNNING
&gt; 2024-03-27 15:35:00,947 [info] Artifacts found. Run name: mlrun_task__15_34_48_703046
&gt; 2024-03-27 15:35:01,881 [info] Job finished: https://dbc-94c947ab-feb9.cloud.databricks.com/?o=4658245941722457#job/499259196347814/run/493449112310004
&gt; 2024-03-27 15:35:01,881 [info] Logs:
+-------------------+------------------+-------+-------+
|favorite_music_type|           avg_age|min_age|max_age|
+-------------------+------------------+-------+-------+
|               Rock|            30.125|     27|     34|
|          Classical|47.666666666666664|     38|     75|
|                Pop|              24.0|     18|     38|
+-------------------+------------------+-------+-------+

2024-03-27 15:34:54,980 - mlrun_logger - INFO - successfully wrote artifact details to the artifact JSON file in DBFS - music_data : /dbfs/demos/mlrun_databricks_demo/music_output_new.parquet
&gt; 2024-03-27 15:35:02,182 [info] To track results use the CLI: {'info_cmd': 'mlrun get run a9c770f8377046bda3061e61a5c015c2 -p mlflow-tracking-example-guy', 'logs_cmd': 'mlrun logs a9c770f8377046bda3061e61a5c015c2 -p mlflow-tracking-example-guy'}
&gt; 2024-03-27 15:35:02,182 [info] Or click for UI: {'ui_url': 'https://dashboard.default-tenant.app.llm-dev.iguazio-cd1.com/mlprojects/mlflow-tracking-example-guy/jobs/monitor/a9c770f8377046bda3061e61a5c015c2/overview'}
&gt; 2024-03-27 15:35:02,182 [info] Run execution finished: {'status': 'completed', 'name': 'process-data-process-data'}
</pre></div>
</div>
<div class="output text_html"><style>
.dictlist {
  background-color: #4EC64B;
  text-align: center;
  margin: 4px;
  border-radius: 3px; padding: 0px 3px 1px 3px; display: inline-block;}
.artifact {
  cursor: pointer;
  background-color: #4EC64B;
  text-align: left;
  margin: 4px; border-radius: 3px; padding: 0px 3px 1px 3px; display: inline-block;
}
div.block.hidden {
  display: none;
}
.clickable {
  cursor: pointer;
}
.ellipsis {
  display: inline-block;
  max-width: 60px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.master-wrapper {
  display: flex;
  flex-flow: row nowrap;
  justify-content: flex-start;
  align-items: stretch;
}
.master-tbl {
  flex: 3
}
.master-wrapper > div {
  margin: 4px;
  padding: 10px;
}
iframe.fileview {
  border: 0 none;
  height: 100%;
  width: 100%;
  white-space: pre-wrap;
}
.pane-header-title {
  width: 80%;
  font-weight: 500;
}
.pane-header {
  line-height: 1;
  background-color: #4EC64B;
  padding: 3px;
}
.pane-header .close {
  font-size: 20px;
  font-weight: 700;
  float: right;
  margin-top: -5px;
}
.master-wrapper .right-pane {
  border: 1px inset silver;
  width: 40%;
  min-height: 300px;
  flex: 3
  min-width: 500px;
}
.master-wrapper * {
  box-sizing: border-box;
}
</style><script>
function copyToClipboard(fld) {
    if (document.queryCommandSupported && document.queryCommandSupported('copy')) {
        var textarea = document.createElement('textarea');
        textarea.textContent = fld.innerHTML;
        textarea.style.position = 'fixed';
        document.body.appendChild(textarea);
        textarea.select();

        try {
            return document.execCommand('copy'); // Security exception may be thrown by some browsers.
        } catch (ex) {

        } finally {
            document.body.removeChild(textarea);
        }
    }
}
function expandPanel(el) {
  const panelName = "#" + el.getAttribute('paneName');
  console.log(el.title);

  document.querySelector(panelName + "-title").innerHTML = el.title
  iframe = document.querySelector(panelName + "-body");

  const tblcss = `<style> body { font-family: Arial, Helvetica, sans-serif;}
    #csv { margin-bottom: 15px; }
    #csv table { border-collapse: collapse;}
    #csv table td { padding: 4px 8px; border: 1px solid silver;} </style>`;

  function csvToHtmlTable(str) {
    return '<div id="csv"><table><tr><td>' +  str.replace(/[\n\r]+$/g, '').replace(/[\n\r]+/g, '</td></tr><tr><td>')
      .replace(/,/g, '</td><td>') + '</td></tr></table></div>';
  }

  function reqListener () {
    if (el.title.endsWith(".csv")) {
      iframe.setAttribute("srcdoc", tblcss + csvToHtmlTable(this.responseText));
    } else {
      iframe.setAttribute("srcdoc", this.responseText);
    }
    console.log(this.responseText);
  }

  const oReq = new XMLHttpRequest();
  oReq.addEventListener("load", reqListener);
  oReq.open("GET", el.title);
  oReq.send();


  //iframe.src = el.title;
  const resultPane = document.querySelector(panelName + "-pane");
  if (resultPane.classList.contains("hidden")) {
    resultPane.classList.remove("hidden");
  }
}
function closePanel(el) {
  const panelName = "#" + el.getAttribute('paneName')
  const resultPane = document.querySelector(panelName + "-pane");
  if (!resultPane.classList.contains("hidden")) {
    resultPane.classList.add("hidden");
  }
}

</script>
<div class="master-wrapper">
<div class="block master-tbl"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>project</th>
<th>uid</th>
<th>iter</th>
<th>start</th>
<th>state</th>
<th>name</th>
<th>labels</th>
<th>inputs</th>
<th>parameters</th>
<th>results</th>
<th>artifacts</th>
</tr>
</thead>
<tbody>
<tr>
<td>mlflow-tracking-example-guy</td>
<td><div title="a9c770f8377046bda3061e61a5c015c2"><a href="https://dashboard.default-tenant.app.llm-dev.iguazio-cd1.com/mlprojects/mlflow-tracking-example-guy/jobs/monitor/a9c770f8377046bda3061e61a5c015c2/overview" target="_blank">...a5c015c2</a></div></td>
<td>0</td>
<td>Mar 27 15:34:48</td>
<td>completed</td>
<td>process-data-process-data</td>
<td><div class="dictlist">v3io_user=zeevr</div><div class="dictlist">kind=databricks</div><div class="dictlist">owner=zeevr</div><div class="dictlist">mlrun/client_version=1.6.1</div><div class="dictlist">mlrun/client_python_version=3.9.16</div><div class="dictlist">host=process-data-process-data-89bhh</div></td>
<td></td>
<td><div class="dictlist">task_parameters={'timeout_minutes': 15, 'spark_app_code': 'IAoKaW1wb3J0IG9zCmltcG9ydCBsb2dnaW5nCm1scnVuX2xvZ2dlciA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKCdtbHJ1bl9sb2dnZXInKQptbHJ1bl9sb2dnZXIuc2V0TGV2ZWwobG9nZ2luZy5ERUJVRykKCm1scnVuX2NvbnNvbGVfaGFuZGxlciA9IGxvZ2dpbmcuU3RyZWFtSGFuZGxlcigpCm1scnVuX2NvbnNvbGVfaGFuZGxlci5zZXRMZXZlbChsb2dnaW5nLkRFQlVHKQptbHJ1bl9mb3JtYXR0ZXIgPSBsb2dnaW5nLkZvcm1hdHRlcignJShhc2N0aW1lKXMgLSAlKG5hbWUpcyAtICUobGV2ZWxuYW1lKXMgLSAlKG1lc3NhZ2UpcycpCm1scnVuX2NvbnNvbGVfaGFuZGxlci5zZXRGb3JtYXR0ZXIobWxydW5fZm9ybWF0dGVyKQptbHJ1bl9sb2dnZXIuYWRkSGFuZGxlcihtbHJ1bl9jb25zb2xlX2hhbmRsZXIpCgptbHJ1bl9kZWZhdWx0X2FydGlmYWN0X3RlbXBsYXRlID0gJ21scnVuX3JldHVybl92YWx1ZV8nCm1scnVuX2FydGlmYWN0X2luZGV4ID0gMAoKCmRlZiBtbHJ1bl9sb2dfYXJ0aWZhY3QobmFtZT0nJywgcGF0aD0nJyk6CiAgICBnbG9iYWwgbWxydW5fYXJ0aWZhY3RfaW5kZXgKICAgIG1scnVuX2FydGlmYWN0X2luZGV4Kz0xICAjICBieSBob3cgbWFueSBhcnRpZmFjdHMgd2UgdHJpZWQgdG8gbG9nLCBub3QgaG93IG1hbnkgc3VjY2VlZC4KICAgIGlmIG5hbWUgaXMgTm9uZSBvciBuYW1lID09ICcnOgogICAgICAgIG5hbWUgPSBmJ3ttbHJ1bl9kZWZhdWx0X2FydGlmYWN0X3RlbXBsYXRlfXttbHJ1bl9hcnRpZmFjdF9pbmRleH0nCiAgICBpZiBub3QgcGF0aDoKICAgICAgICBtbHJ1bl9sb2dnZXIuZXJyb3IoZidwYXRoIHJlcXVpcmVkIGZvciBsb2dnaW5nIGFuIG1scnVuIGFydGlmYWN0IC0ge25hbWV9IDoge3BhdGh9JykKICAgICAgICByZXR1cm4KICAgIGlmIG5vdCBpc2luc3RhbmNlKG5hbWUsIHN0cikgb3Igbm90IGlzaW5zdGFuY2UocGF0aCwgc3RyKToKICAgICAgICBtbHJ1bl9sb2dnZXIuZXJyb3IoZiduYW1lIGFuZCBwYXRoIG11c3QgYmUgaW4gc3RyaW5nIHR5cGUgZm9yIGxvZ2dpbmcgYW4gbWxydW4gYXJ0aWZhY3QgLSB7bmFtZX0gOiB7cGF0aH0nKQogICAgICAgIHJldHVybgogICAgaWYgbm90IHBhdGguc3RhcnRzd2l0aCgnL2RiZnMnKSBhbmQgbm90IHBhdGguc3RhcnRzd2l0aCgnZGJmczovJyk6CiAgICAgICAgbWxydW5fbG9nZ2VyLmVycm9yKGYncGF0aCBmb3IgYW4gbWxydW4gYXJ0aWZhY3QgbXVzdCBzdGFydCB3aXRoIC9kYmZzIG9yIGRiZnM6LyAtIHtuYW1lfSA6IHtwYXRofScpCiAgICAgICAgcmV0dXJuCiAgICBtbHJ1bl9hcnRpZmFjdHNfcGF0aCA9ICcvZGJmcy9tbHJ1bl9kYXRhYnJpY2tzX3J1bnRpbWUvYXJ0aWZhY3RzX2RpY3Rpb25hcmllcy9tbHJ1bl9hcnRpZmFjdF9hOWM3NzBmODM3NzA0NmJkYTMwNjFlNjFhNWMwMTVjMi5qc29uJwogICAgdHJ5OgogICAgICAgIG5ld19kYXRhID0ge25hbWU6cGF0aH0KICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhtbHJ1bl9hcnRpZmFjdHNfcGF0aCk6CiAgICAgICAgICAgIHdpdGggb3BlbihtbHJ1bl9hcnRpZmFjdHNfcGF0aCwgJ3IrJykgYXMganNvbl9maWxlOgogICAgICAgICAgICAgICAgZXhpc3RpbmdfZGF0YSA9IGpzb24ubG9hZChqc29uX2ZpbGUpCiAgICAgICAgICAgICAgICBleGlzdGluZ19kYXRhLnVwZGF0ZShuZXdfZGF0YSkKICAgICAgICAgICAgICAgIGpzb25fZmlsZS5zZWVrKDApCiAgICAgICAgICAgICAgICBqc29uLmR1bXAoZXhpc3RpbmdfZGF0YSwganNvbl9maWxlKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHBhcmVudF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUobWxydW5fYXJ0aWZhY3RzX3BhdGgpCiAgICAgICAgICAgIGlmIHBhcmVudF9kaXIgIT0gJy9kYmZzJzoKICAgICAgICAgICAgICAgIG9zLm1ha2VkaXJzKHBhcmVudF9kaXIsIGV4aXN0X29rPVRydWUpCiAgICAgICAgICAgIHdpdGggb3BlbihtbHJ1bl9hcnRpZmFjdHNfcGF0aCwgJ3cnKSBhcyBqc29uX2ZpbGU6CiAgICAgICAgICAgICAgICBqc29uLmR1bXAobmV3X2RhdGEsIGpzb25fZmlsZSkKICAgICAgICBzdWNjZXNzX2xvZyA9IGYnc3VjY2Vzc2Z1bGx5IHdyb3RlIGFydGlmYWN0IGRldGFpbHMgdG8gdGhlIGFydGlmYWN0IEpTT04gZmlsZSBpbiBEQkZTIC0ge25hbWV9IDoge3BhdGh9JwogICAgICAgIG1scnVuX2xvZ2dlci5pbmZvKHN1Y2Nlc3NfbG9nKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyB1bmtub3duX2V4Y2VwdGlvbjoKICAgICAgICBtbHJ1bl9sb2dnZXIuZXJyb3IoZidsb2cgbWxydW4gYXJ0aWZhY3QgZmFpbGVkIC0ge25hbWV9IDoge3BhdGh9LiBlcnJvcjoge3Vua25vd25fZXhjZXB0aW9ufScpCgoKCgppbXBvcnQgYXJncGFyc2UKaW1wb3J0IGpzb24KcGFyc2VyID0gYXJncGFyc2UuQXJndW1lbnRQYXJzZXIoKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCdoYW5kbGVyX2FyZ3VtZW50cycpCmhhbmRsZXJfYXJndW1lbnRzID0gcGFyc2VyLnBhcnNlX2FyZ3MoKS5oYW5kbGVyX2FyZ3VtZW50cwpoYW5kbGVyX2FyZ3VtZW50cyA9IGpzb24ubG9hZHMoaGFuZGxlcl9hcmd1bWVudHMpCgoKZnJvbSBweXNwYXJrLnNxbCBpbXBvcnQgU3BhcmtTZXNzaW9uCmZyb20gcHlzcGFyay5zcWwuZnVuY3Rpb25zIGltcG9ydCBhdmcsIG1pbiwgbWF4CmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IGpzb24KaW1wb3J0IGZzc3BlYwoKZGVmIHByb2Nlc3NfZGF0YShkYXRhX3BhdGg6IHN0ciwgZGF0YV9vdXRwdXRfcGF0aDogc3RyKToKICAgIHNwYXJrID0gU3BhcmtTZXNzaW9uLmJ1aWxkZXIuYXBwTmFtZSgnTXVzaWNEZW1vJykuZ2V0T3JDcmVhdGUoKQogICAgc3BhcmtfZGYgPSBzcGFyay5yZWFkLnBhcnF1ZXQoZGF0YV9wYXRoLCBoZWFkZXI9VHJ1ZSkKICAgIHNwYXJrX2RmID0gc3BhcmtfZGYuZHJvcCgnbmFtZScsICdpZCcpCiAgICBtdXNpY19zdGF0cyA9IHNwYXJrX2RmLmdyb3VwQnkoJ2Zhdm9yaXRlX211c2ljX3R5cGUnKS5hZ2coYXZnKCdhZ2UnKS5hbGlhcygnYXZnX2FnZScpLCBtaW4oJ2FnZScpLmFsaWFzKCdtaW5fYWdlJyksIG1heCgnYWdlJykuYWxpYXMoJ21heF9hZ2UnKSkKICAgIG11c2ljX3N0YXRzLnNob3coKQogICAgcGFuZGFzX2RmID0gc3BhcmtfZGYudG9QYW5kYXMoKQogICAgcGFuZGFzX2RmLnRvX3BhcnF1ZXQoZGF0YV9vdXRwdXRfcGF0aCkKICAgIHJldHVybiB7J211c2ljX2RhdGEnOiBkYXRhX291dHB1dF9wYXRofQpyZXN1bHQgPSBwcm9jZXNzX2RhdGEoKipoYW5kbGVyX2FyZ3VtZW50cykKCgppZiByZXN1bHQ6CiAgICBpZiBpc2luc3RhbmNlKHJlc3VsdCwgZGljdCk6CiAgICAgICAgZm9yIGtleSwgcGF0aCBpbiByZXN1bHQuaXRlbXMoKToKICAgICAgICAgICAgbWxydW5fbG9nX2FydGlmYWN0KG5hbWU9a2V5LCBwYXRoPXBhdGgpCiAgICBlbGlmIGlzaW5zdGFuY2UocmVzdWx0LCAobGlzdCwgdHVwbGUsIHNldCkpOgogICAgICAgIGZvciBhcnRpZmFjdF9wYXRoIGluIHJlc3VsdDoKICAgICAgICAgICAgbWxydW5fbG9nX2FydGlmYWN0KHBhdGg9YXJ0aWZhY3RfcGF0aCkKICAgIGVsaWYgaXNpbnN0YW5jZShyZXN1bHQsIHN0cik6CiAgICAgICAgbWxydW5fbG9nX2FydGlmYWN0KHBhdGg9cmVzdWx0KQogICAgZWxzZToKICAgICAgICBtbHJ1bl9sb2dnZXIud2FybmluZyhmJ2NhbiBub3QgbG9nIGFydGlmYWN0cyB3aXRoIHRoZSByZXN1bHQgb2YgaGFuZGxlciBmdW5jdGlvbiAtIHJlc3VsdCBpbiB1bnN1cHBvcnRlZCB0eXBlLiB7dHlwZShyZXN1bHQpfScpCg==', 'original_handler': 'process_data', 'artifact_json_path': '/mlrun_databricks_runtime/artifacts_dictionaries/mlrun_artifact_a9c770f8377046bda3061e61a5c015c2.json'}</div><div class="dictlist">data_path=dbfs:///demos/mlrun_databricks_demo/1711553684480_33/music.parquet</div><div class="dictlist">data_output_path=/dbfs/demos/mlrun_databricks_demo/music_output_new.parquet</div></td>
<td></td>
<td><div title="dbfs:///demos/mlrun_databricks_demo/music_output_new.parquet">music_data</div><div class="artifact" onclick="expandPanel(this)" panename="result3ef5f0ed" title="files/v3io/projects/mlflow-tracking-example-guy/artifacts/process-data-process-data/0/databricks_run_metadata.json">databricks_run_metadata</div></td>
</tr>
</tbody>
</table>
</div></div>
<div class="right-pane block hidden" id="result3ef5f0ed-pane">
<div class="pane-header">
<span class="pane-header-title" id="result3ef5f0ed-title">Title</span>
<span class="close clickable" onclick="closePanel(this)" panename="result3ef5f0ed">×</span>
</div>
<iframe class="fileview" id="result3ef5f0ed-body"></iframe>
</div>
</div>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output text_html"><b> &gt; to track results use the .show() or .logs() methods  or <a href="https://dashboard.default-tenant.app.llm-dev.iguazio-cd1.com/mlprojects/mlflow-tracking-example-guy/jobs/monitor/a9c770f8377046bda3061e61a5c015c2/overview" target="_blank">click here</a> to open in UI</b></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&gt; 2024-03-27 15:35:07,910 [info] Run execution finished: {'status': 'completed', 'name': 'process-data-process-data'}
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-an-mlflow-xgboost-function">
<h2>Create an MLflow Xgboost function<a class="headerlink" href="#create-an-mlflow-xgboost-function" title="Permalink to this headline">#</a></h2>
<p>The following code demonstrates how to create a simple Xgboost model using MLflow and log the results.
MLflow will log the model, parameters, metrics, and artifacts, and MLRun will track the run and collect the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> training.py

<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">mlflow.xgboost</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
<span class="kn">from</span> <span class="nn">mlflow</span> <span class="kn">import</span> <span class="n">log_metric</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">log_loss</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">def</span> <span class="nf">example_xgb_run</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="s2">"f"</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="s2">"Pop"</span><span class="p">,</span> <span class="s2">"Rock"</span><span class="p">,</span> <span class="s2">"Classical"</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    
    <span class="c1"># Prepare, train, and test data</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'favorite_music_type'</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span>

    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
    <span class="p">)</span>

    <span class="c1"># Enable auto logging</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">xgboost</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>

    <span class="n">dtrain</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_train</span><span class="p">)</span>
    <span class="n">dtest</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_test</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
        <span class="c1"># Train model</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"objective"</span><span class="p">:</span> <span class="s2">"multi:softprob"</span><span class="p">,</span>
            <span class="s2">"num_class"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">"learning_rate"</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
            <span class="s2">"eval_metric"</span><span class="p">:</span> <span class="s2">"mlogloss"</span><span class="p">,</span>
            <span class="s2">"colsample_bytree"</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">"subsample"</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">"seed"</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">dtrain</span><span class="p">,</span> <span class="n">evals</span><span class="o">=</span><span class="p">[(</span><span class="n">dtrain</span><span class="p">,</span> <span class="s2">"train"</span><span class="p">)])</span>
        
        <span class="c1"># Evaluate model</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dtest</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_proba</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        
        <span class="c1"># Log metrics by hand</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">({</span><span class="s2">"log_loss"</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="s2">"accuracy"</span><span class="p">:</span> <span class="n">acc</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Overwriting training.py
</pre></div>
</div>
</div>
</div>
</section>
<section id="log-the-data-from-mlflow-in-mlrun">
<h2>Log the data from MLflow in MLRun<a class="headerlink" href="#log-the-data-from-mlflow-in-mlrun" title="Permalink to this headline">#</a></h2>
<section id="change-the-mlrun-configuration-to-use-the-tracker">
<h3>Change the MLRun configuration to use the tracker<a class="headerlink" href="#change-the-mlrun-configuration-to-use-the-tracker" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlrun</span>

<span class="n">mlrun</span><span class="o">.</span><span class="n">mlconf</span><span class="o">.</span><span class="n">external_platform_tracking</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<p>These are the three options to run tracking:</p>
<ul class="simple">
<li><p>Set: <code class="docutils literal notranslate"><span class="pre">mlrun.mlconf.external_platform_tracking.mlflow.match_experiment_to_runtime</span></code> to True. This determines the run id and is the safest method</p></li>
<li><p>Set the experiment name at: <code class="docutils literal notranslate"><span class="pre">mlflow.environment_variables.MLFLOW_EXPERIMENT_NAME.set</span></code>. This determines the experiment mlrun will track and find the run added to it.</p></li>
<li><p>Just run it, mlrun will look across all experiments and search for added run, this is not recomended.</p></li>
</ul>
</section>
<section id="create-the-mlrun-function">
<h3>Create the mlrun function<a class="headerlink" href="#create-the-mlrun-function" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the first run option from above</span>
<span class="n">mlrun</span><span class="o">.</span><span class="n">mlconf</span><span class="o">.</span><span class="n">external_platform_tracking</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">match_experiment_to_runtime</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Create a MLRun function using the example train file (all the functions must be located in it):</span>
<span class="n">training_func</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">set_function</span><span class="p">(</span>
    <span class="n">func</span><span class="o">=</span><span class="s2">"training.py"</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"example-xgb-run"</span><span class="p">,</span>
    <span class="n">kind</span><span class="o">=</span><span class="s2">"job"</span><span class="p">,</span>
    <span class="n">image</span><span class="o">=</span><span class="s2">"mlrun/mlrun"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-the-function">
<h3>Run the function<a class="headerlink" href="#run-the-function" title="Permalink to this headline">#</a></h3>
<p>Run the function using MLRun. This will log the data from MLflow in MLRun.
After running the function, you can look at the UI and see that all metrics and parameters are logged in MLRun.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlrun.feature_store</span> <span class="k">as</span> <span class="nn">fstore</span>

<span class="n">feature_set</span> <span class="o">=</span> <span class="n">fstore</span><span class="o">.</span><span class="n">get_feature_set</span><span class="p">(</span><span class="s2">"music_fset"</span><span class="p">,</span> <span class="s2">"mlflow-tracking-example"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">feature_set</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">'id'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># df = project.list_().to_objects()[0].to_dataitem().as_df()</span>
<span class="n">df_path</span> <span class="o">=</span> <span class="s2">"./music.parquet"</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the example code using mlrun</span>
<span class="n">train_run</span> <span class="o">=</span> <span class="n">training_func</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">handler</span><span class="o">=</span><span class="s2">"example_xgb_run"</span><span class="p">,</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">"df"</span><span class="p">:</span> <span class="n">df_path</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&gt; 2024-03-27 15:37:22,829 [info] Storing function: {'name': 'example-xgb-run-example-xgb-run', 'uid': '6ff324dd21d64b6290d45a001957dda2', 'db': 'http://mlrun-api:8080'}
&gt; 2024-03-27 15:37:22,912 [warning] `mlconf.external_platform_tracking.mlflow.match_experiment_to_runtime` is set to True but the MLFlow experiment name environment variable ('MLFLOW_EXPERIMENT_NAME') is set for using the name: 'example-xgb-run-example-xgb-run'. This name will be overriden with MLRun's runtime name as set in the MLRun configuration: 'example-xgb-run-example-xgb-run'.
[0]	train-mlogloss:0.82467
[1]	train-mlogloss:0.64706
[2]	train-mlogloss:0.52480
[3]	train-mlogloss:0.43768
[4]	train-mlogloss:0.37410
[5]	train-mlogloss:0.32686
[6]	train-mlogloss:0.29057
[7]	train-mlogloss:0.26192
[8]	train-mlogloss:0.23885
[9]	train-mlogloss:0.22004
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024/03/27 15:37:23 WARNING mlflow.utils.autologging_utils: MLflow autologging encountered a warning: "/User/.pythonlibs/mlrun-base/lib/python3.9/site-packages/mlflow/types/utils.py:393: UserWarning: Hint: Inferred schema contains integer column(s). Integer columns in Python cannot represent missing values. If your input data contains missing values at inference time, it will be encoded as floats and will cause a schema enforcement error. The best way to avoid this problem is to infer the model schema based on a realistic data sample (training dataset) that includes missing values. Alternatively, you can declare integer columns as doubles (float64) whenever these columns may have missing values. See `Handling Integers With Missing Values &lt;https://www.mlflow.org/docs/latest/models.html#handling-integers-with-missing-values&gt;`_ for more details."
2024/03/27 15:37:23 WARNING mlflow.utils.autologging_utils: MLflow autologging encountered a warning: "/User/.pythonlibs/mlrun-base/lib/python3.9/site-packages/xgboost/core.py:160: UserWarning: [15:37:23] WARNING: /workspace/src/c_api/c_api.cc:1240: Saving into deprecated binary model format, please consider using `json` or `ubj`. Model format will default to JSON in XGBoost 2.2 if not specified."
</pre></div>
</div>
<div class="output text_html"><style>
.dictlist {
  background-color: #4EC64B;
  text-align: center;
  margin: 4px;
  border-radius: 3px; padding: 0px 3px 1px 3px; display: inline-block;}
.artifact {
  cursor: pointer;
  background-color: #4EC64B;
  text-align: left;
  margin: 4px; border-radius: 3px; padding: 0px 3px 1px 3px; display: inline-block;
}
div.block.hidden {
  display: none;
}
.clickable {
  cursor: pointer;
}
.ellipsis {
  display: inline-block;
  max-width: 60px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.master-wrapper {
  display: flex;
  flex-flow: row nowrap;
  justify-content: flex-start;
  align-items: stretch;
}
.master-tbl {
  flex: 3
}
.master-wrapper > div {
  margin: 4px;
  padding: 10px;
}
iframe.fileview {
  border: 0 none;
  height: 100%;
  width: 100%;
  white-space: pre-wrap;
}
.pane-header-title {
  width: 80%;
  font-weight: 500;
}
.pane-header {
  line-height: 1;
  background-color: #4EC64B;
  padding: 3px;
}
.pane-header .close {
  font-size: 20px;
  font-weight: 700;
  float: right;
  margin-top: -5px;
}
.master-wrapper .right-pane {
  border: 1px inset silver;
  width: 40%;
  min-height: 300px;
  flex: 3
  min-width: 500px;
}
.master-wrapper * {
  box-sizing: border-box;
}
</style><script>
function copyToClipboard(fld) {
    if (document.queryCommandSupported && document.queryCommandSupported('copy')) {
        var textarea = document.createElement('textarea');
        textarea.textContent = fld.innerHTML;
        textarea.style.position = 'fixed';
        document.body.appendChild(textarea);
        textarea.select();

        try {
            return document.execCommand('copy'); // Security exception may be thrown by some browsers.
        } catch (ex) {

        } finally {
            document.body.removeChild(textarea);
        }
    }
}
function expandPanel(el) {
  const panelName = "#" + el.getAttribute('paneName');
  console.log(el.title);

  document.querySelector(panelName + "-title").innerHTML = el.title
  iframe = document.querySelector(panelName + "-body");

  const tblcss = `<style> body { font-family: Arial, Helvetica, sans-serif;}
    #csv { margin-bottom: 15px; }
    #csv table { border-collapse: collapse;}
    #csv table td { padding: 4px 8px; border: 1px solid silver;} </style>`;

  function csvToHtmlTable(str) {
    return '<div id="csv"><table><tr><td>' +  str.replace(/[\n\r]+$/g, '').replace(/[\n\r]+/g, '</td></tr><tr><td>')
      .replace(/,/g, '</td><td>') + '</td></tr></table></div>';
  }

  function reqListener () {
    if (el.title.endsWith(".csv")) {
      iframe.setAttribute("srcdoc", tblcss + csvToHtmlTable(this.responseText));
    } else {
      iframe.setAttribute("srcdoc", this.responseText);
    }
    console.log(this.responseText);
  }

  const oReq = new XMLHttpRequest();
  oReq.addEventListener("load", reqListener);
  oReq.open("GET", el.title);
  oReq.send();


  //iframe.src = el.title;
  const resultPane = document.querySelector(panelName + "-pane");
  if (resultPane.classList.contains("hidden")) {
    resultPane.classList.remove("hidden");
  }
}
function closePanel(el) {
  const panelName = "#" + el.getAttribute('paneName')
  const resultPane = document.querySelector(panelName + "-pane");
  if (!resultPane.classList.contains("hidden")) {
    resultPane.classList.add("hidden");
  }
}

</script>
<div class="master-wrapper">
<div class="block master-tbl"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>project</th>
<th>uid</th>
<th>iter</th>
<th>start</th>
<th>state</th>
<th>name</th>
<th>labels</th>
<th>inputs</th>
<th>parameters</th>
<th>results</th>
<th>artifacts</th>
</tr>
</thead>
<tbody>
<tr>
<td>mlflow-tracking-example-guy</td>
<td><div title="6ff324dd21d64b6290d45a001957dda2"><a href="https://dashboard.default-tenant.app.llm-dev.iguazio-cd1.com/mlprojects/mlflow-tracking-example-guy/jobs/monitor/6ff324dd21d64b6290d45a001957dda2/overview" target="_blank">...1957dda2</a></div></td>
<td>0</td>
<td>Mar 27 15:37:22</td>
<td>completed</td>
<td>example-xgb-run-example-xgb-run</td>
<td><div class="dictlist">v3io_user=zeevr</div><div class="dictlist">kind=local</div><div class="dictlist">owner=zeevr</div><div class="dictlist">host=jupyter-zeevr-9f4ffb7bb-8c4mf</div><div class="dictlist">mlflow-user=iguazio</div><div class="dictlist">mlflow-run-name=stately-cow-437</div><div class="dictlist">mlflow-run-id=f66d6149d54c4958a2485c941d86a538</div><div class="dictlist">mlflow-experiment-id=608717337209571124</div></td>
<td><div title="/User/music.parquet">df</div></td>
<td><div class="dictlist">colsample_bytree=1.0</div><div class="dictlist">custom_metric=None</div><div class="dictlist">early_stopping_rounds=None</div><div class="dictlist">eval_metric=mlogloss</div><div class="dictlist">learning_rate=0.3</div><div class="dictlist">maximize=None</div><div class="dictlist">num_boost_round=10</div><div class="dictlist">num_class=3</div><div class="dictlist">objective=multi:softprob</div><div class="dictlist">seed=42</div><div class="dictlist">subsample=1.0</div><div class="dictlist">verbose_eval=True</div></td>
<td><div class="dictlist">accuracy=0.7142857142857143</div><div class="dictlist">log_loss=0.9622776094122579</div><div class="dictlist">train-mlogloss=0.2200447738170624</div></td>
<td><div class="artifact" onclick="expandPanel(this)" panename="resulte1ace3d4" title="files/v3io/projects/mlflow-tracking-example-guy/artifacts/example-xgb-run-example-xgb-run/0/feature_importance_weight_json.json">feature_importance_weight_json</div><div class="artifact" onclick="expandPanel(this)" panename="resulte1ace3d4" title="files/v3io/projects/mlflow-tracking-example-guy/artifacts/example-xgb-run-example-xgb-run/0/feature_importance_weight_png.png">feature_importance_weight_png</div><div title="v3io:///projects/mlflow-tracking-example-guy/artifacts/example-xgb-run-example-xgb-run/0/model/">model</div></td>
</tr>
</tbody>
</table>
</div></div>
<div class="right-pane block hidden" id="resulte1ace3d4-pane">
<div class="pane-header">
<span class="pane-header-title" id="resulte1ace3d4-title">Title</span>
<span class="close clickable" onclick="closePanel(this)" panename="resulte1ace3d4">×</span>
</div>
<iframe class="fileview" id="resulte1ace3d4-body"></iframe>
</div>
</div>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output text_html"><b> &gt; to track results use the .show() or .logs() methods  or <a href="https://dashboard.default-tenant.app.llm-dev.iguazio-cd1.com/mlprojects/mlflow-tracking-example-guy/jobs/monitor/6ff324dd21d64b6290d45a001957dda2/overview" target="_blank">click here</a> to open in UI</b></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&gt; 2024-03-27 15:37:31,415 [info] Run execution finished: {'status': 'completed', 'name': 'example-xgb-run-example-xgb-run'}
</pre></div>
</div>
</div>
</div>
</section>
<section id="examine-the-results">
<h3>Examine the results<a class="headerlink" href="#examine-the-results" title="Permalink to this headline">#</a></h3>
<p>You can examine the results using the UI or by looking at the outputs of the run.
The outputs include the model, the metrics, and the artifacts, and are completely independent of MLflow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_run</span><span class="o">.</span><span class="n">outputs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{'accuracy': 0.7142857142857143,
 'log_loss': 0.9622776094122579,
 'train-mlogloss': 0.2200447738170624,
 'feature_importance_weight_json': 'store://artifacts/mlflow-tracking-example-guy/example-xgb-run-example-xgb-run_feature_importance_weight_json@6ff324dd21d64b6290d45a001957dda2',
 'feature_importance_weight_png': 'store://artifacts/mlflow-tracking-example-guy/example-xgb-run-example-xgb-run_feature_importance_weight_png@6ff324dd21d64b6290d45a001957dda2',
 'model': 'store://artifacts/mlflow-tracking-example-guy/example-xgb-run-example-xgb-run_model@6ff324dd21d64b6290d45a001957dda2'}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_run</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{'accuracy': 0.7142857142857143,
 'log_loss': 0.9622776094122579,
 'train-mlogloss': 0.2200447738170624}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_run</span><span class="o">.</span><span class="n">artifact</span><span class="p">(</span><span class="s2">"feature_importance_weight_png"</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3edebfb8ca78ff860681bc18084495dd1fefd44d69ead3b64c7b3e0b0170adbb.png" src="_images/3edebfb8ca78ff860681bc18084495dd1fefd44d69ead3b64c7b3e0b0170adbb.png"/>
</div>
</div>
</section>
<section id="you-can-also-examine-the-results-using-the-ui">
<h3>You can also examine the results using the UI<a class="headerlink" href="#you-can-also-examine-the-results-using-the-ui" title="Permalink to this headline">#</a></h3>
<p>Look at collected artifacts:</p>
<p><img alt="image.png" src="attachment:95b9b198-55c9-4a67-b0bf-103c9ae0272e.png"/></p>
<p>And at results:</p>
<p><img alt="image.png" src="attachment:66422f79-9b46-4e07-9796-c1b350c26c9c.png"/></p>
</section>
</section>
<section id="use-the-function-for-model-serving">
<h2>Use the function for model serving<a class="headerlink" href="#use-the-function-for-model-serving" title="Permalink to this headline">#</a></h2>
<section id="create-the-server-and-serving-function">
<h3>Create the server and serving function<a class="headerlink" href="#create-the-server-and-serving-function" title="Permalink to this headline">#</a></h3>
<p>Create a serving function that uses the model from the previous run and serves it using MLRun.
We will create a mock server to test the model in a local environment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">serving_func</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">set_function</span><span class="p">(</span>
    <span class="n">func</span><span class="o">=</span><span class="s2">"function.yaml"</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"example-xgb-server"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add the model</span>
<span class="n">serving_func</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
    <span class="s2">"mlflow_xgb_model"</span><span class="p">,</span>
    <span class="n">class_name</span><span class="o">=</span><span class="s2">"MLFlowModelServer"</span><span class="p">,</span>
    <span class="n">model_path</span><span class="o">=</span><span class="n">train_run</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">"model"</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;mlrun.serving.states.TaskStep at 0x7f77c3e4c9a0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a mock server</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">serving_func</span><span class="o">.</span><span class="n">to_mock_server</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&gt; 2024-03-27 15:37:31,627 [info] model mlflow_xgb_model was loaded
&gt; 2024-03-27 15:37:31,628 [info] Loaded ['mlflow_xgb_model']
</pre></div>
</div>
</div>
</div>
</section>
<section id="test-the-model">
<h3>Test the model<a class="headerlink" href="#test-the-model" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># An example taken randomly  </span>
<span class="n">result</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="s2">"/v2/models/mlflow_xgb_model/predict"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"inputs"</span><span class="p">:[{</span><span class="s2">"age"</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">"gender"</span><span class="p">:</span> <span class="mi">0</span><span class="p">}]})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Look at the result, it shows the probability of the given example to be each of the </span>
<span class="c1"># irises featured in the dataset</span>
<span class="n">result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{'id': '43a61d06f2694fa695bdd6561b487131',
 'model_name': 'mlflow_xgb_model',
 'outputs': [[0.9242361187934875, 0.0418272465467453, 0.033936627209186554]]}
</pre></div>
</div>
</div>
</div>
<p>We predicted that a 20 year old female would like pop!</p>
</section>
</section>
</section>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
      © Copyright .<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>